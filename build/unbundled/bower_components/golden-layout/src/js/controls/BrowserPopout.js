lm.controls.BrowserPopout=function(t,i,n,o,e){lm.utils.EventEmitter.call(this),this.isInitialised=!1,this._config=t,this._dimensions=i,this._parentId=n,this._indexInParent=o,this._layoutManager=e,this._popoutWindow=null,this._id=null,this._createWindow()},lm.utils.copy(lm.controls.BrowserPopout.prototype,{toConfig:function(){return{dimensions:{width:this.getGlInstance().width,height:this.getGlInstance().height,left:this._popoutWindow.screenX||this._popoutWindow.screenLeft,top:this._popoutWindow.screenY||this._popoutWindow.screenTop},content:this.getGlInstance().toConfig().content,parentId:this._parentId,indexInParent:this._indexInParent}},getGlInstance:function(){return this._popoutWindow.__glInstance},getWindow:function(){return this._popoutWindow},close:function(){if(this.getGlInstance())this.getGlInstance()._$closeWindow();else try{this.getWindow().close()}catch(t){}},popIn:function(){var t,i,n=this._indexInParent;this._parentId&&(t=$.extend(!0,{},this.getGlInstance().toConfig()).content[0],i=this._layoutManager.root.getItemsById(this._parentId)[0],i||(i=this._layoutManager.root.contentItems.length>0?this._layoutManager.root.contentItems[0]:this._layoutManager.root,n=0)),i.addChild(t,this._indexInParent),this.close()},_createWindow:function(){var t,i=this._createUrl(),n=Math.floor(1e6*Math.random()).toString(36),o=this._serializeWindowOptions({width:this._dimensions.width,height:this._dimensions.height,innerWidth:this._dimensions.width,innerHeight:this._dimensions.height,menubar:"no",toolbar:"no",location:"no",personalbar:"no",resizable:"yes",scrollbars:"no",status:"no"});if(this._popoutWindow=window.open(i,n,o),this._popoutWindow)$(this._popoutWindow).on("load",lm.utils.fnBind(this._positionWindow,this)).on("unload beforeunload",lm.utils.fnBind(this._onClose,this)),t=setInterval(lm.utils.fnBind(function(){this._popoutWindow.__glInstance&&this._popoutWindow.__glInstance.isInitialised&&(this._onInitialised(),clearInterval(t))},this),10);else if(this._layoutManager.config.settings.blockedPopoutsThrowError===!0){var e=new Error("Popout blocked");throw e.type="popoutBlocked",e}},_serializeWindowOptions:function(t){var i,n=[];for(i in t)n.push(i+"="+t[i]);return n.join(",")},_createUrl:function(){var t,i={content:this._config},n="gl-window-config-"+lm.utils.getUniqueId();i=(new lm.utils.ConfigMinifier).minifyConfig(i);try{localStorage.setItem(n,JSON.stringify(i))}catch(o){throw new Error("Error while writing to localStorage "+o.toString())}return t=document.location.href.split("?"),1===t.length?t[0]+"?gl-window="+n:document.location.href+"&gl-window="+n},_positionWindow:function(){this._popoutWindow.moveTo(this._dimensions.left,this._dimensions.top),this._popoutWindow.focus()},_onInitialised:function(){this.isInitialised=!0,this.getGlInstance().on("popIn",this.popIn,this),this.emit("initialised")},_onClose:function(){setTimeout(lm.utils.fnBind(this.emit,this,["closed"]),50)}});