<html><head><link rel="import" href="templatizer.html">
<link rel="import" href="../collection.html">

<script>Polymer({is:"dom-repeat","extends":"template",_template:null,properties:{items:{type:Array},as:{type:String,value:"item"},indexAs:{type:String,value:"index"},sort:{type:Function,observer:"_sortChanged"},filter:{type:Function,observer:"_filterChanged"},observe:{type:String,observer:"_observeChanged"},delay:Number,renderedItemCount:{type:Number,notify:!0,readOnly:!0},initialCount:{type:Number,observer:"_initializeChunking"},targetFramerate:{type:Number,value:20},_targetFrameTime:{type:Number,computed:"_computeFrameTime(targetFramerate)"}},behaviors:[Polymer.Templatizer],observers:["_itemsChanged(items.*)"],created:function(){this._instances=[],this._pool=[],this._limit=1/0;var e=this;this._boundRenderChunk=function(){e._renderChunk()}},detached:function(){this.__isDetached=!0;for(var e=0;e<this._instances.length;e++)this._detachInstance(e)},attached:function(){if(this.__isDetached){this.__isDetached=!1;for(var e=Polymer.dom(Polymer.dom(this).parentNode),t=0;t<this._instances.length;t++)this._attachInstance(t,e)}},ready:function(){this._instanceProps={__key__:!0},this._instanceProps[this.as]=!0,this._instanceProps[this.indexAs]=!0,this.ctor||this.templatize(this)},_sortChanged:function(e){var t=this._getRootDataHost();this._sortFn=e&&("function"==typeof e?e:function(){return t[e].apply(t,arguments)}),this._needFullRefresh=!0,this.items&&this._debounceTemplate(this._render)},_filterChanged:function(e){var t=this._getRootDataHost();this._filterFn=e&&("function"==typeof e?e:function(){return t[e].apply(t,arguments)}),this._needFullRefresh=!0,this.items&&this._debounceTemplate(this._render)},_computeFrameTime:function(e){return Math.ceil(1e3/e)},_initializeChunking:function(){this.initialCount&&(this._limit=this.initialCount,this._chunkCount=this.initialCount,this._lastChunkTime=performance.now())},_tryRenderChunk:function(){this.items&&this._limit<this.items.length&&this.debounce("renderChunk",this._requestRenderChunk)},_requestRenderChunk:function(){requestAnimationFrame(this._boundRenderChunk)},_renderChunk:function(){var e=performance.now(),t=this._targetFrameTime/(e-this._lastChunkTime);this._chunkCount=Math.round(this._chunkCount*t)||1,this._limit+=this._chunkCount,this._lastChunkTime=e,this._debounceTemplate(this._render)},_observeChanged:function(){this._observePaths=this.observe&&this.observe.replace(".*",".").split(" ")},_itemsChanged:function(e){if("items"==e.path)Array.isArray(this.items)?this.collection=Polymer.Collection.get(this.items):this.items?this._error(this._logf("dom-repeat","expected array for `items`, found",this.items)):this.collection=null,this._keySplices=[],this._indexSplices=[],this._needFullRefresh=!0,this._initializeChunking(),this._debounceTemplate(this._render);else if("items.splices"==e.path)this._keySplices=this._keySplices.concat(e.value.keySplices),this._indexSplices=this._indexSplices.concat(e.value.indexSplices),this._debounceTemplate(this._render);else{var t=e.path.slice(6);this._forwardItemPath(t,e.value),this._checkObservedPaths(t)}},_checkObservedPaths:function(e){if(this._observePaths){e=e.substring(e.indexOf(".")+1);for(var t=this._observePaths,i=0;i<t.length;i++)if(0===e.indexOf(t[i]))return this._needFullRefresh=!0,void(this.delay?this.debounce("render",this._render,this.delay):this._debounceTemplate(this._render))}},render:function(){this._needFullRefresh=!0,this._debounceTemplate(this._render),this._flushTemplates()},_render:function(){this._needFullRefresh?(this._applyFullRefresh(),this._needFullRefresh=!1):this._keySplices.length&&(this._sortFn?this._applySplicesUserSort(this._keySplices):this._filterFn?this._applyFullRefresh():this._applySplicesArrayOrder(this._indexSplices)),this._keySplices=[],this._indexSplices=[];for(var e=this._keyToInstIdx={},t=this._instances.length-1;t>=0;t--){var i=this._instances[t];i.isPlaceholder&&t<this._limit?i=this._insertInstance(t,i.__key__):!i.isPlaceholder&&t>=this._limit&&(i=this._downgradeInstance(t,i.__key__)),e[i.__key__]=t,i.isPlaceholder||i.__setProperty(this.indexAs,t,!0)}this._pool.length=0,this._setRenderedItemCount(this._instances.length),this.fire("dom-change"),this._tryRenderChunk()},_applyFullRefresh:function(){var e,t=this.collection;if(this._sortFn)e=t?t.getKeys():[];else{e=[];var i=this.items;if(i)for(var s=0;s<i.length;s++)e.push(t.getKey(i[s]))}var n=this;for(this._filterFn&&(e=e.filter(function(e){return n._filterFn(t.getItem(e))})),this._sortFn&&e.sort(function(e,i){return n._sortFn(t.getItem(e),t.getItem(i))}),s=0;s<e.length;s++){var r=e[s],h=this._instances[s];h?(h.__key__=r,!h.isPlaceholder&&s<this._limit&&h.__setProperty(this.as,t.getItem(r),!0)):s<this._limit?this._insertInstance(s,r):this._insertPlaceholder(s,r)}for(var o=this._instances.length-1;o>=s;o--)this._detachAndRemoveInstance(o)},_numericSort:function(e,t){return e-t},_applySplicesUserSort:function(e){for(var t,i,s=this.collection,n={},r=0;r<e.length&&(i=e[r]);r++){for(var h=0;h<i.removed.length;h++)t=i.removed[h],n[t]=n[t]?null:-1;for(h=0;h<i.added.length;h++)t=i.added[h],n[t]=n[t]?null:1}var o=[],a=[];for(t in n)n[t]===-1&&o.push(this._keyToInstIdx[t]),1===n[t]&&a.push(t);if(o.length)for(o.sort(this._numericSort),r=o.length-1;r>=0;r--){var _=o[r];void 0!==_&&this._detachAndRemoveInstance(_)}var l=this;if(a.length){this._filterFn&&(a=a.filter(function(e){return l._filterFn(s.getItem(e))})),a.sort(function(e,t){return l._sortFn(s.getItem(e),s.getItem(t))});var c=0;for(r=0;r<a.length;r++)c=this._insertRowUserSort(c,a[r])}},_insertRowUserSort:function(e,t){for(var i=this.collection,s=i.getItem(t),n=this._instances.length-1,r=-1;e<=n;){var h=e+n>>1,o=this._instances[h].__key__,a=this._sortFn(i.getItem(o),s);if(a<0)e=h+1;else{if(!(a>0)){r=h;break}n=h-1}}return r<0&&(r=n+1),this._insertPlaceholder(r,t),r},_applySplicesArrayOrder:function(e){for(var t,i=0;i<e.length&&(t=e[i]);i++){for(var s=0;s<t.removed.length;s++)this._detachAndRemoveInstance(t.index);for(s=0;s<t.addedKeys.length;s++)this._insertPlaceholder(t.index+s,t.addedKeys[s])}},_detachInstance:function(e){var t=this._instances[e];if(!t.isPlaceholder){for(var i=0;i<t._children.length;i++){var s=t._children[i];Polymer.dom(t.root).appendChild(s)}return t}},_attachInstance:function(e,t){var i=this._instances[e];i.isPlaceholder||t.insertBefore(i.root,this)},_detachAndRemoveInstance:function(e){var t=this._detachInstance(e);t&&this._pool.push(t),this._instances.splice(e,1)},_insertPlaceholder:function(e,t){this._instances.splice(e,0,{isPlaceholder:!0,__key__:t})},_stampInstance:function(e,t){var i={__key__:t};return i[this.as]=this.collection.getItem(t),i[this.indexAs]=e,this.stamp(i)},_insertInstance:function(e,t){var i=this._pool.pop();i?(i.__setProperty(this.as,this.collection.getItem(t),!0),i.__setProperty("__key__",t,!0)):i=this._stampInstance(e,t);var s=this._instances[e+1],n=s&&!s.isPlaceholder?s._children[0]:this,r=Polymer.dom(this).parentNode;return Polymer.dom(r).insertBefore(i.root,n),this._instances[e]=i,i},_downgradeInstance:function(e,t){var i=this._detachInstance(e);return i&&this._pool.push(i),i={isPlaceholder:!0,__key__:t},this._instances[e]=i,i},_showHideChildren:function(e){for(var t=0;t<this._instances.length;t++)this._instances[t]._showHideChildren(e)},_forwardInstanceProp:function(e,t,i){if(t==this.as){var s;s=this._sortFn||this._filterFn?this.items.indexOf(this.collection.getItem(e.__key__)):e[this.indexAs],this.set("items."+s,i)}},_forwardInstancePath:function(e,t,i){0===t.indexOf(this.as+".")&&this._notifyPath("items."+e.__key__+"."+t.slice(this.as.length+1),i)},_forwardParentProp:function(e,t){for(var i,s=this._instances,n=0;n<s.length&&(i=s[n]);n++)i.isPlaceholder||i.__setProperty(e,t,!0)},_forwardParentPath:function(e,t){for(var i,s=this._instances,n=0;n<s.length&&(i=s[n]);n++)i.isPlaceholder||i._notifyPath(e,t,!0)},_forwardItemPath:function(e,t){if(this._keyToInstIdx){var i=e.indexOf("."),s=e.substring(0,i<0?e.length:i),n=this._keyToInstIdx[s],r=this._instances[n];r&&!r.isPlaceholder&&(i>=0?(e=this.as+"."+e.substring(i+1),r._notifyPath(e,t,!0)):r.__setProperty(this.as,t,!0))}},itemForElement:function(e){var t=this.modelForElement(e);return t&&t[this.as]},keyForElement:function(e){var t=this.modelForElement(e);return t&&t.__key__},indexForElement:function(e){var t=this.modelForElement(e);return t&&t[this.indexAs]}});</script>
</head><body></body></html>